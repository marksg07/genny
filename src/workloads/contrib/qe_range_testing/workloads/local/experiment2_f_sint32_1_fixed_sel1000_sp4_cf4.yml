SchemaVersion: 2018-07-01
Owner: "@10gen/server-security"
Description: |
  Queryable Encryption Range Experiment 2

GlobalDefaults:
  Database: &encrypted_db genny_qerangebench_experiment2
  Collection: &encrypted_coll ContiguousValuesFreqOne
  ClientName: &encrypted_pool EncryptedPool
  Nop: &nop {Nop: true}

Encryption:
  
  UseCryptSharedLib: true
  CryptSharedLibPath: /home/ubuntu/mongo_crypt/lib/mongo_crypt_v1.so
  
  EncryptedCollections:
  - Database: *encrypted_db
    Collection: *encrypted_coll
    EncryptionType: queryable

    QueryableEncryptedFields:
      f_sint32_1: { type: "int", queries: [{queryType: "rangePreview", min: -2147483648, max: 2147483647, contention: 4, sparsity: 4}] }
      f_sint32_2: { type: "int", queries: [{queryType: "rangePreview", min: 1, max: 100000, contention: 4, sparsity: 4}] }
      f_bin64_1: { type: "double", queries: [{queryType: "rangePreview", contention: 4, sparsity: 4}] }
      f_bin64_2: { type: "double", queries: [{queryType: "rangePreview", min: -100, max: 100, precision: 4, contention: 4, sparsity: 4}] }
      f_dec128_1: { type: "decimal", queries: [{queryType: "rangePreview", contention: 4, sparsity: 4}] }
      f_dec128_2: { type: "decimal", queries: [{queryType: "rangePreview", min: -50000000, max: 50000000, precision: 4, contention: 4, sparsity: 4}] }

Clients:
  EncryptedPool:
    QueryOptions:
      maxPoolSize: 400
    EncryptionOptions:
      KeyVaultDatabase: "keyvault"
      KeyVaultCollection: "datakeys"
      EncryptedCollections:
      - genny_qerangebench_experiment2.ContiguousValuesFreqOne

Actors:

  - Name: InsertActor_Thread0
    Type: CrudActor
    Threads: 1
    Database: *encrypted_db
    ClientName: *encrypted_pool
    Phases:
    - Repeat: 25
      Collection: *encrypted_coll
      MetricsName: "load"
      Operations:
      - OperationName: insertOne
        OperationMetricsName: inserts
        OperationCommand:
          Document:
            f_sint32_1: {^ConvertToInt32: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 0}}}}
            f_sint32_2: {^ConvertToInt32: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 0}}}}
            f_bin64_1: {^ConvertToDouble: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 0}}}}
            f_bin64_2: {^ConvertToDouble: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/tenthousandths.txt", "sequential": true, "startFromLine": 0}}}}
            f_dec128_1: {^ConvertToDecimal: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 0}}}}
            f_dec128_2: {^ConvertToDecimal: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/tenthousandths.txt", "sequential": true, "startFromLine": 0}}}}
            _id: {^Inc: {start: 0, multiplier: 25}}
    - *nop

  - Name: InsertActor_Thread1
    Type: CrudActor
    Threads: 1
    Database: *encrypted_db
    ClientName: *encrypted_pool
    Phases:
    - Repeat: 25
      Collection: *encrypted_coll
      MetricsName: "load"
      Operations:
      - OperationName: insertOne
        OperationMetricsName: inserts
        OperationCommand:
          Document:
            f_sint32_1: {^ConvertToInt32: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 25}}}}
            f_sint32_2: {^ConvertToInt32: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 25}}}}
            f_bin64_1: {^ConvertToDouble: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 25}}}}
            f_bin64_2: {^ConvertToDouble: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/tenthousandths.txt", "sequential": true, "startFromLine": 25}}}}
            f_dec128_1: {^ConvertToDecimal: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 25}}}}
            f_dec128_2: {^ConvertToDecimal: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/tenthousandths.txt", "sequential": true, "startFromLine": 25}}}}
            _id: {^Inc: {start: 0, multiplier: 25}}
    - *nop

  - Name: InsertActor_Thread2
    Type: CrudActor
    Threads: 1
    Database: *encrypted_db
    ClientName: *encrypted_pool
    Phases:
    - Repeat: 25
      Collection: *encrypted_coll
      MetricsName: "load"
      Operations:
      - OperationName: insertOne
        OperationMetricsName: inserts
        OperationCommand:
          Document:
            f_sint32_1: {^ConvertToInt32: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 50}}}}
            f_sint32_2: {^ConvertToInt32: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 50}}}}
            f_bin64_1: {^ConvertToDouble: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 50}}}}
            f_bin64_2: {^ConvertToDouble: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/tenthousandths.txt", "sequential": true, "startFromLine": 50}}}}
            f_dec128_1: {^ConvertToDecimal: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 50}}}}
            f_dec128_2: {^ConvertToDecimal: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/tenthousandths.txt", "sequential": true, "startFromLine": 50}}}}
            _id: {^Inc: {start: 0, multiplier: 25}}
    - *nop

  - Name: InsertActor_Thread3
    Type: CrudActor
    Threads: 1
    Database: *encrypted_db
    ClientName: *encrypted_pool
    Phases:
    - Repeat: 25
      Collection: *encrypted_coll
      MetricsName: "load"
      Operations:
      - OperationName: insertOne
        OperationMetricsName: inserts
        OperationCommand:
          Document:
            f_sint32_1: {^ConvertToInt32: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 75}}}}
            f_sint32_2: {^ConvertToInt32: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 75}}}}
            f_bin64_1: {^ConvertToDouble: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 75}}}}
            f_bin64_2: {^ConvertToDouble: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/tenthousandths.txt", "sequential": true, "startFromLine": 75}}}}
            f_dec128_1: {^ConvertToDecimal: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 75}}}}
            f_dec128_2: {^ConvertToDecimal: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/tenthousandths.txt", "sequential": true, "startFromLine": 75}}}}
            _id: {^Inc: {start: 0, multiplier: 25}}
    - *nop

  - Name: InsertActor_Thread4
    Type: CrudActor
    Threads: 1
    Database: *encrypted_db
    ClientName: *encrypted_pool
    Phases:
    - Repeat: 25
      Collection: *encrypted_coll
      MetricsName: "load"
      Operations:
      - OperationName: insertOne
        OperationMetricsName: inserts
        OperationCommand:
          Document:
            f_sint32_1: {^ConvertToInt32: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 100}}}}
            f_sint32_2: {^ConvertToInt32: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 100}}}}
            f_bin64_1: {^ConvertToDouble: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 100}}}}
            f_bin64_2: {^ConvertToDouble: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/tenthousandths.txt", "sequential": true, "startFromLine": 100}}}}
            f_dec128_1: {^ConvertToDecimal: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 100}}}}
            f_dec128_2: {^ConvertToDecimal: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/tenthousandths.txt", "sequential": true, "startFromLine": 100}}}}
            _id: {^Inc: {start: 0, multiplier: 25}}
    - *nop

  - Name: InsertActor_Thread5
    Type: CrudActor
    Threads: 1
    Database: *encrypted_db
    ClientName: *encrypted_pool
    Phases:
    - Repeat: 25
      Collection: *encrypted_coll
      MetricsName: "load"
      Operations:
      - OperationName: insertOne
        OperationMetricsName: inserts
        OperationCommand:
          Document:
            f_sint32_1: {^ConvertToInt32: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 125}}}}
            f_sint32_2: {^ConvertToInt32: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 125}}}}
            f_bin64_1: {^ConvertToDouble: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 125}}}}
            f_bin64_2: {^ConvertToDouble: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/tenthousandths.txt", "sequential": true, "startFromLine": 125}}}}
            f_dec128_1: {^ConvertToDecimal: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 125}}}}
            f_dec128_2: {^ConvertToDecimal: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/tenthousandths.txt", "sequential": true, "startFromLine": 125}}}}
            _id: {^Inc: {start: 0, multiplier: 25}}
    - *nop

  - Name: InsertActor_Thread6
    Type: CrudActor
    Threads: 1
    Database: *encrypted_db
    ClientName: *encrypted_pool
    Phases:
    - Repeat: 25
      Collection: *encrypted_coll
      MetricsName: "load"
      Operations:
      - OperationName: insertOne
        OperationMetricsName: inserts
        OperationCommand:
          Document:
            f_sint32_1: {^ConvertToInt32: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 150}}}}
            f_sint32_2: {^ConvertToInt32: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 150}}}}
            f_bin64_1: {^ConvertToDouble: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 150}}}}
            f_bin64_2: {^ConvertToDouble: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/tenthousandths.txt", "sequential": true, "startFromLine": 150}}}}
            f_dec128_1: {^ConvertToDecimal: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 150}}}}
            f_dec128_2: {^ConvertToDecimal: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/tenthousandths.txt", "sequential": true, "startFromLine": 150}}}}
            _id: {^Inc: {start: 0, multiplier: 25}}
    - *nop

  - Name: InsertActor_Thread7
    Type: CrudActor
    Threads: 1
    Database: *encrypted_db
    ClientName: *encrypted_pool
    Phases:
    - Repeat: 25
      Collection: *encrypted_coll
      MetricsName: "load"
      Operations:
      - OperationName: insertOne
        OperationMetricsName: inserts
        OperationCommand:
          Document:
            f_sint32_1: {^ConvertToInt32: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 175}}}}
            f_sint32_2: {^ConvertToInt32: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 175}}}}
            f_bin64_1: {^ConvertToDouble: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 175}}}}
            f_bin64_2: {^ConvertToDouble: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/tenthousandths.txt", "sequential": true, "startFromLine": 175}}}}
            f_dec128_1: {^ConvertToDecimal: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/ones.txt", "sequential": true, "startFromLine": 175}}}}
            f_dec128_2: {^ConvertToDecimal: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/misc/tenthousandths.txt", "sequential": true, "startFromLine": 175}}}}
            _id: {^Inc: {start: 0, multiplier: 25}}
    - *nop


  - Name: PreDefinedRangeQueryActor
    Type: CrudActor
    Threads: 1
    Database: *encrypted_db
    ClientName: *encrypted_pool
    Phases:
    - *nop
    - Repeat: 100
      Collection: *encrypted_coll
      MetricsName: "query"
      Operations:
      - OperationName: find
        OperationMetricsName: range_query
        OperationCommand:
          Filter: { f_sint32_1: {
              $gte: {^ConvertToInt32: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/queries/experiment2_min_fixed_sel1000_ones.txt", "sequential": true}}}},
              $lte: {^ConvertToInt32: {from: {^ChooseFromDataset:{"path": "./src/workloads/contrib/qe_range_testing/queries/experiment2_max_fixed_sel1000_ones.txt", "sequential": true}}}}
            }
          }

  - Name: LoggingActor0
    Type: LoggingActor
    Threads: 1
    Phases:
      - *nop
      - Phase: 1
        LogEvery: 5 minutes
        Blocking: None

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - single-replica-fle
    branch_name:
      $gte: v7.0